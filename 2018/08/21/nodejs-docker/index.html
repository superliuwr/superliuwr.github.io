<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Running Node.js Apps with Docker/Docker Compose | SUPERLOG</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="Checklist of dockerizing an applicationChoose a base imageConsider to use Alpine images. Install the necessary packages You need to write apt-get update and apt-get install on the same line (same if y">
<meta name="keywords" content="Docker,Nodejs">
<meta property="og:type" content="article">
<meta property="og:title" content="Running Node.js Apps with Docker&#x2F;Docker Compose">
<meta property="og:url" content="http://superliuwr.github.io/2018/08/21/nodejs-docker/index.html">
<meta property="og:site_name" content="SUPERLOG">
<meta property="og:description" content="Checklist of dockerizing an applicationChoose a base imageConsider to use Alpine images. Install the necessary packages You need to write apt-get update and apt-get install on the same line (same if y">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-08-22T13:31:46.143Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Running Node.js Apps with Docker&#x2F;Docker Compose">
<meta name="twitter:description" content="Checklist of dockerizing an applicationChoose a base imageConsider to use Alpine images. Install the necessary packages You need to write apt-get update and apt-get install on the same line (same if y">
  
    <link rel="alternative" href="/atom.xml" title="SUPERLOG" type="application/atom+xml">
  
  
    <link rel="icon" href="images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>
<body>
  <div id="container">
    <div class="mobile-nav-panel">
	<i class="icon-reorder icon-large"></i>
</div>
<header id="header">
	<h1 class="blog-title">
		<a href="/">SUPERLOG</a>
	</h1>
	<nav class="nav">
		<ul>
			<li><a href="/">Home</a></li><li><a href="/categories/">Categories</a></li><li><a href="/tags/">Tags</a></li><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li>
			<li><a id="nav-search-btn" class="nav-icon" title="Search"></a></li>
			<li><a href="/atom.xml" id="nav-rss-link" class="nav-icon" title="RSS Feed"></a></li>
		</ul>
	</nav>
	<div id="search-form-wrap">
		<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://superliuwr.github.io"></form>
	</div>
</header>
    <div id="main">
      <article id="post-nodejs-docker" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2018/08/21/nodejs-docker/" class="article-date">
  <time datetime="2018-08-21T12:08:55.000Z" itemprop="datePublished">2018-08-21</time>
</a>
		</span>
		<span class="meta-elements author">Marvin Liu</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 class="article-title entry-title" itemprop="name">
      Running Node.js Apps with Docker/Docker Compose
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<h1 id="Checklist-of-dockerizing-an-application"><a href="#Checklist-of-dockerizing-an-application" class="headerlink" title="Checklist of dockerizing an application"></a>Checklist of dockerizing an application</h1><h2 id="Choose-a-base-image"><a href="#Choose-a-base-image" class="headerlink" title="Choose a base image"></a>Choose a base image</h2><p>Consider to use Alpine images.</p>
<h2 id="Install-the-necessary-packages"><a href="#Install-the-necessary-packages" class="headerlink" title="Install the necessary packages"></a>Install the necessary packages</h2><ul>
<li>You need to write <code>apt-get update</code> and <code>apt-get install</code> on the same line (same if you are using apk on Alpine).</li>
<li>Double check if you are installing ONLY what you really need (assuming you will run the container on production).</li>
</ul>
<h2 id="Add-your-custom-files"><a href="#Add-your-custom-files" class="headerlink" title="Add your custom files"></a>Add your custom files</h2><ul>
<li>Understand the different between COPY and ADD</li>
<li>Follow File System conventions on where to place your files</li>
<li>Check the attributes of the files you are adding. If you need execution permission, there is no need to add a new layer on your image (<code>RUN chmod +x</code>). Just fix the original attributes on your code repository.</li>
</ul>
<h2 id="Define-which-user-will-or-can-run-your-container"><a href="#Define-which-user-will-or-can-run-your-container" class="headerlink" title="Define which user will (or can) run your container"></a>Define which user will (or can) run your container</h2><ul>
<li>Without any other option provided, processes in containers will execute as root (unless a different uid was supplied in the Dockerfile).</li>
<li>You only need to run your container with a specific (fixed ID) user if your application need access to the user or group tables (<code>/etc/passwd</code> or <code>/etc/group</code>).</li>
<li>Avoid running your container as root as much as possible.</li>
<li>Note some applications require you to run them with specific ids (e.g. Elastic Search with uid:gid = 1000:1000).</li>
</ul>
<h2 id="Define-the-exposed-ports"><a href="#Define-the-exposed-ports" class="headerlink" title="Define the exposed ports"></a>Define the exposed ports</h2><h2 id="Define-the-entrypoint"><a href="#Define-the-entrypoint" class="headerlink" title="Define the entrypoint"></a>Define the entrypoint</h2><p>Create a <code>docker-entrypoint.sh</code> script where you can hook things like configuration using environment variables.</p>
<p>Examples</p>
<ul>
<li><a href="https://github.com/elastic/elasticsearch-docker/tree/master/build/elasticsearch/bin" target="_blank" rel="noopener">elasticsearch</a></li>
<li><a href="https://github.com/docker-library/postgres/tree/de8ba87d50de466a1e05e111927d2bc30c2db36d/10" target="_blank" rel="noopener">postgres</a></li>
</ul>
<h2 id="Define-a-Configuration-method"><a href="#Define-a-Configuration-method" class="headerlink" title="Define a Configuration method"></a>Define a Configuration method</h2><p>Every application requires some kind of parametrization. There are basically two paths you can follow:</p>
<ul>
<li>Use an application specific configuration file: them you will need to document the format, fields, location and so on (not good if you have a complex environment, with applications spanning different technologies).</li>
<li>Use (operating system) Environment variables: Simple and efficient.</li>
</ul>
<h2 id="Externalize-your-data"><a href="#Externalize-your-data" class="headerlink" title="Externalize your data"></a>Externalize your data</h2><p>The golden rule is: do not save any persistent data inside the container.</p>
<p>The container file system is supposed and intended to be temporary, ephemeral. So any user generated content, data files, process output should be saved either on a mounted volume or on a bind mounts (that is, on a folder on the Base OS linked inside the container).</p>
<h2 id="Make-sure-you-handle-the-logs-as-well"><a href="#Make-sure-you-handle-the-logs-as-well" class="headerlink" title="Make sure you handle the logs as well"></a>Make sure you handle the logs as well</h2><p>If you are creating a new app and want it to stick to docker conventions, no logs files should be written at all. The application should use stdout and stderr as an event stream.</p>
<p>Docker will automatically capture everything you are sending to stdout and make it available through “docker logs” command.</p>
<h2 id="Rotate-logs-and-other-append-only-files"><a href="#Rotate-logs-and-other-append-only-files" class="headerlink" title="Rotate logs and other append only files"></a>Rotate logs and other append only files</h2><p>If your application is writing log files or appending any files that can grow indefinitely, you need to worry about file rotation.</p>
<p>This is critical for you to prevent the server running out of space, apply data retention policies (which is critical when it comes to GDPR and other data regulations).</p>
<p><a href="https://www.aerospike.com/docs/operations/configure/log/logrotate.html" target="_blank" rel="noopener">Example of log rotation using logrotate</a></p>
<h1 id="Lean-image-with-Docker-multi-stage-build"><a href="#Lean-image-with-Docker-multi-stage-build" class="headerlink" title="Lean image with Docker multi-stage build"></a>Lean image with Docker multi-stage build</h1><p>Docker 17.05 extends Dockerfile syntax to support new multi-stage build, by extending two commands: FROM and COPY.</p>
<p>The multi-stage build allows using multiple FROM commands in the same Dockerfile. The last FROM command produces the final Docker image, all other images are intermediate images (no final Docker image is produced, but all layers are cached).</p>
<p>The FROM syntax also supports AS keyword. Use AS keyword to give the current image a logical name and reference to it later by this name.</p>
<p>To copy files from intermediate images use <code>COPY --from=&lt;image_AS_name|image_number&gt;</code>, where number starts from 0 (but better to use logical name through AS keyword).</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---- Base Node ----</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.5</span> AS base</span><br><span class="line"><span class="comment"># install node</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk add --no-cache nodejs-current tini</span></span><br><span class="line"><span class="bash"><span class="comment"># set working directory</span></span></span><br><span class="line"><span class="bash">WORKDIR /root/chat</span></span><br><span class="line"><span class="bash"><span class="comment"># Set tini as entrypoint</span></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/sbin/tini"</span>, <span class="string">"--"</span>]</span></span><br><span class="line"><span class="bash"><span class="comment"># copy project file</span></span></span><br><span class="line"><span class="bash">COPY package.json .</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="bash"><span class="comment"># ---- Dependencies ----</span></span></span><br><span class="line"><span class="bash">FROM base AS dependencies</span></span><br><span class="line"><span class="bash"><span class="comment"># install node packages</span></span></span><br><span class="line"><span class="bash">RUN npm <span class="built_in">set</span> progress=<span class="literal">false</span> &amp;&amp; npm config <span class="built_in">set</span> depth 0</span></span><br><span class="line"><span class="bash">RUN npm install --only=production </span></span><br><span class="line"><span class="bash"><span class="comment"># copy production node_modules aside</span></span></span><br><span class="line"><span class="bash">RUN cp -R node_modules prod_node_modules</span></span><br><span class="line"><span class="bash"><span class="comment"># install ALL node_modules, including 'devDependencies'</span></span></span><br><span class="line"><span class="bash">RUN npm install</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="bash"><span class="comment"># ---- Test ----</span></span></span><br><span class="line"><span class="bash"><span class="comment"># run linters, setup and tests</span></span></span><br><span class="line"><span class="bash">FROM dependencies AS <span class="built_in">test</span></span></span><br><span class="line"><span class="bash">COPY . .</span></span><br><span class="line"><span class="bash">RUN  npm run lint &amp;&amp; npm run setup &amp;&amp; npm run <span class="built_in">test</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="bash"><span class="comment"># ---- Release ----</span></span></span><br><span class="line"><span class="bash">FROM base AS release</span></span><br><span class="line"><span class="bash"><span class="comment"># copy production node_modules</span></span></span><br><span class="line"><span class="bash">COPY --from=dependencies /root/chat/prod_node_modules ./node_modules</span></span><br><span class="line"><span class="bash"><span class="comment"># copy app sources</span></span></span><br><span class="line"><span class="bash">COPY . .</span></span><br><span class="line"><span class="bash"><span class="comment"># expose port and define CMD</span></span></span><br><span class="line"><span class="bash">EXPOSE 5000</span></span><br><span class="line"><span class="bash">CMD npm run start</span></span><br></pre></td></tr></table></figure>
<h1 id="Docker-Compose-for-NodeJS-Development"><a href="#Docker-Compose-for-NodeJS-Development" class="headerlink" title="Docker Compose for NodeJS Development"></a>Docker Compose for NodeJS Development</h1><p>An important concept to understand is that Docker Compose spans “buildtime” and “runtime”. Up until now, we have been building images using docker build ., which is “buildtime.” This is when our containers are actually built. We can think of “runtime” as what happens once our containers are built and being used.</p>
<p>Compose triggers “buildtime” — instructing our images and containers to build — but it also populates data used at “runtime,” such as env vars and volumes. This is important to be clear on. For instance, when we add things like volumes and command, they will override the same things that may have been set up via the Dockerfile at “buildtime.”</p>
<h1 id="How-to-debug-a-Node-js-application-in-a-Docker-container"><a href="#How-to-debug-a-Node-js-application-in-a-Docker-container" class="headerlink" title="How to debug a Node.js application in a Docker container"></a>How to debug a Node.js application in a Docker container</h1><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://hackernoon.com/how-to-dockerize-any-application-b60ad00e76da" target="_blank" rel="noopener">How to dockerize any application</a></li>
<li><a href="https://tonybai.com/2017/11/11/multi-stage-image-build-in-docker/" target="_blank" rel="noopener">理解Docker的多阶段镜像构建</a></li>
</ul>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
  <div class="article-category">
    <a class="article-category-link" href="/categories/DevOps/">DevOps</a>
  </div>

			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li></ul>

			</span>
		</div>
	</footer>
	
    
<nav id="article-nav">
  
  
    <a href="/2018/08/20/dockerfile/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          Dockerfile
        
      </div>
    </a>
  
</nav>

  
</article>




    </div>
    <div class="mb-search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:superliuwr.github.io">
  </form>
</div>
<footer id="footer">
	<h1 class="footer-blog-title">
		<a href="/">SUPERLOG</a>
	</h1>
	<span class="copyright">
		&copy; 2018 Marvin Liu<br>
		Modify from <a href="http://sanographix.github.io/tumblr/apollo/" target="_blank">Apollo</a> theme, designed by <a href="http://www.sanographix.net/" target="_blank">SANOGRAPHIX.NET</a><br>
		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	</span>
</footer>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>